# cartridge
Shell utilities for managing LUKS encrypted volumes

## Usage
The cartridge utilities use a master key for deriving volume keys. The
keyfile can be specified using the `-k` argument for the `cryptformat`
and `cryptmount` utilities.

A device must first be formatted using `cryptformat` before it can be
mounted using `cryptmount`.

```
# cryptformat -k keyfile /dev/sda
meta-data=/dev/mapper/crypt-7b210e95-3a04-4140-a56f-8b845eb6f3a8 isize=512    agcount=4, agsize=130048 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=1, sparse=1, rmapbt=0
         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
data     =                       bsize=4096   blocks=520192, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
log      =internal log           bsize=4096   blocks=16384, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
Device '/dev/sda was successfully formatted.
```

Once the volume is formatted in can be mounted using `cryptmount`. The
mount directory will be persistently autogenerated based on the device
path.

```
# cryptmount -k keyfile /dev/sda
Device /dev/sda was successfully mounted on /mnt/6bd2f207-c025-3448-90c1-c570d74c3c20
```

When you're done using the volume, you can safely unmount it using
`crypteject`. This will unmount the filesystem, close the LUKS volume
and then spin down the device using `hdparm -Y`.

```
# crypteject /dev/sda
Device /dev/sda can now be safely removed.
```

## Keyfile recommendations

While the keyfile can be a plaintext document, for maximum security it
is recommended to store the key encrypted and only decrypt it when
necessary. This can be easily accomplished by using the `age`
encryption utility.

First encrypt the keyfile using a passphrase by running the following
command:
```
# age -p -a < keyfile > keyfile.enc
```

After encrypting the keyfile, you can mount or format volumes using
the following commands:

```
# age -d keyfile.enc | cryptformat -k /dev/stdin /dev/sda
# age -d keyfile.enc | cryptmount -k /dev/stdin /dev/sda
```

## Auto-mounting using udev

While not recommended as it requires the key to be stored in plaintext; it is possible to automount volumes by adding the following udev rule:
```
# /etc/udev/rules.d/90-cartridge.rule
ACTION=="add",SUBSYSTEM=="block",ENV{ID_FS_TYPE}=="crypto_LUKS",ENV{ID_FS_USAGE}=="crypto",RUN+="/usr/local/bin/cryptmount -k /etc/cartridge.key '%E{DEVNAME}'"
```
